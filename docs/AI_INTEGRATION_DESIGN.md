# TodoMate AI 통합 설계서

## 1. 개요

### 1.1 목적
Gemini AI를 활용하여 사용자의 할 일 관리를 더 스마트하게 지원한다.

### 1.2 핵심 원칙
- **사용자 우선**: AI는 제안만 하고, 최종 결정은 사용자가 한다
- **투명성**: AI가 왜 그렇게 제안했는지 이해할 수 있어야 한다
- **비침습적**: 사용자가 설정한 값을 AI가 임의로 변경하지 않는다

---

## 2. 기능 목록

### 2.1 자동 태깅 (Life Area 제안)
- 할 일의 제목과 설명을 분석하여 적합한 생활 영역을 제안
- 사용자가 직접 설정한 태그는 절대 덮어쓰지 않음
- 제안을 수락하거나 무시할 수 있음

### 2.2 격려 메시지
- 대시보드 상단에 현재 진행 상황 기반 메시지 표시
- 잘하고 있는 점과 개선할 점을 균형있게 전달
- 동기부여와 방향 제시

### 2.3 할 일 추천
- 불균형한 영역에 대한 구체적인 할 일 제안
- 사용자의 기존 패턴을 고려한 맞춤 추천

### 2.4 패턴 분석
- 영역 간 숨겨진 연관성 발견
- 새로운 생활 영역 제안
- 주간/월간 트렌드 분석

---

## 3. 데이터 모델 변경

### 3.1 TodoEntity 확장

```kotlin
// 기존 필드
val lifeAreaId: Long? = null  // 사용자가 직접 설정

// 새로 추가할 필드
val aiSuggestedAreaId: Long? = null  // AI가 제안한 영역
val aiAnalyzedAt: Long? = null       // AI 분석 시점 (null이면 미분석)
```

### 3.2 새로운 Entity: AiInsight

```kotlin
@Entity(tableName = "ai_insights")
data class AiInsightEntity(
    @PrimaryKey(autoGenerate = true)
    val id: Long = 0,
    val type: String,           // "ENCOURAGEMENT", "RECOMMENDATION", "PATTERN"
    val content: String,        // AI 메시지 내용
    val metadata: String?,      // JSON 형태의 추가 데이터
    val weekStartDate: Long,    // 해당 주
    val createdAt: Long = System.currentTimeMillis(),
    val expiresAt: Long         // 만료 시점
)
```

---

## 4. 태그 충돌 방지 로직

### 4.1 원칙
```
사용자 설정 (lifeAreaId) > AI 제안 (aiSuggestedAreaId)
```

### 4.2 시나리오별 동작

**시나리오 1: 새 할 일 생성 (영역 미지정)**
```
1. 사용자가 할 일 저장 (lifeAreaId = null)
2. 백그라운드에서 AI 분석 실행
3. aiSuggestedAreaId에 제안 저장
4. 목록에서 "AI 추천: OOO" 표시
5. 사용자가 [적용] 클릭 → lifeAreaId에 복사
6. 사용자가 [무시] 클릭 → aiSuggestedAreaId = null
```

**시나리오 2: 새 할 일 생성 (영역 지정)**
```
1. 사용자가 할 일 저장 (lifeAreaId = 3)
2. AI 분석 실행하지 않음 (이미 사용자가 지정)
3. aiSuggestedAreaId = null 유지
```

**시나리오 3: 기존 할 일 수정 (영역 변경)**
```
1. 사용자가 영역을 직접 변경
2. lifeAreaId 업데이트
3. aiSuggestedAreaId = null로 초기화 (제안 무효화)
```

**시나리오 4: 기존 할 일 수정 (제목/설명만 변경)**
```
1. 사용자가 제목이나 설명 수정
2. lifeAreaId가 null인 경우에만 AI 재분석
3. lifeAreaId가 있으면 AI 분석 안 함
```

---

## 5. AI 호출 설계

### 5.1 호출 타이밍

**자동 태깅**
- 시점: 할 일 저장 직후 (비동기)
- 조건: lifeAreaId가 null일 때만
- 빈도: 할 일당 1회 (aiAnalyzedAt이 null일 때)

**격려 메시지**
- 시점: 대시보드 화면 진입 시
- 조건: 캐시된 메시지가 없거나 만료됐을 때
- 빈도: 1일 1회 또는 데이터 변경 시

**할 일 추천**
- 시점: 사용자가 "추천받기" 버튼 클릭 시
- 조건: 없음 (항상 실행)
- 빈도: 사용자 요청 시마다

**패턴 분석**
- 시점: 주 1회 자동 또는 사용자 요청
- 조건: 최소 10개 이상의 할 일 데이터
- 빈도: 주 1회

### 5.2 API 호출 최적화

**배치 처리**
- 여러 할 일의 태깅 요청을 모아서 한 번에 처리
- 최대 10개씩 묶어서 API 호출

**캐싱 전략**
- 격려 메시지: 24시간 캐시
- 패턴 분석: 7일 캐시
- 할 일 추천: 캐시 없음 (항상 새로 생성)

**에러 처리**
- API 실패 시 기본 메시지 표시
- 재시도: 최대 2회, 지수 백오프
- 오프라인: 캐시된 데이터 사용

---

## 6. UI/UX 설계

### 6.1 대시보드 레이아웃

```
┌────────────────────────────────────┐
│ [←]     Life Direction      [목표][⋮] │  ← 툴바
├────────────────────────────────────┤
│ ┌────────────────────────────────┐ │
│ │ 💬 "이번 주 학습 영역 목표의   │ │  ← AI 격려 메시지
│ │     120% 달성! 정말 대단해요"  │ │
│ │                    [새 메시지] │ │
│ └────────────────────────────────┘ │
├────────────────────────────────────┤
│      [◀]  2/3 ~ 2/9  [▶]          │  ← 주간 네비게이션
├────────────────────────────────────┤
│                                    │
│         ╭───────────╮              │
│        ╱   3D 차트   ╲             │  ← 3D 레이더 차트
│       ╱               ╲            │
│      ╰─────────────────╯           │
│                                    │
├────────────────────────────────────┤
│ 생활 영역              [영역 관리] │  ← 하단 영역 바
│ 커리어 | 건강 | 학습 | 관계 | 재정 │
└────────────────────────────────────┘
```

### 6.2 할 일 목록 - AI 제안 표시

```
┌────────────────────────────────────┐
│ ☐ 운동하기                         │
│   설명: 헬스장 가서 30분 운동      │
│   ┌──────────────────────────────┐ │
│   │ 🤖 AI 추천: 건강  [적용][무시]│ │  ← AI 제안 배너
│   └──────────────────────────────┘ │
├────────────────────────────────────┤
│ ☑ 보고서 작성                      │
│   🏷️ 커리어                        │  ← 사용자 설정 태그
└────────────────────────────────────┘
```

### 6.3 AI 제안 적용 플로우

```
[할 일 저장]
     ↓
[lifeAreaId 확인]
     ↓
  null? ──YES──→ [AI 분석 요청]
     │                 ↓
    NO           [제안 저장]
     │                 ↓
     ↓           [UI에 제안 표시]
  [완료]               ↓
              [사용자 선택 대기]
                   ↓
          ┌────────┴────────┐
       [적용]            [무시]
          ↓                 ↓
    [lifeAreaId     [aiSuggestedAreaId
       = 제안값]         = null]
```

---

## 7. Gemini API 연동

### 7.1 의존성

```kotlin
// build.gradle.kts
implementation("com.google.ai.client.generativeai:generativeai:0.9.0")
```

### 7.2 프롬프트 설계

**자동 태깅 프롬프트**
```
당신은 할 일 분류 전문가입니다.

[생활 영역 목록]
{areas}

[할 일 정보]
제목: {title}
설명: {description}

위 할 일이 어떤 생활 영역에 해당하는지 분석해주세요.
반드시 목록에 있는 영역 중 하나를 선택하세요.
확실하지 않으면 "알 수 없음"이라고 답하세요.

응답 형식 (JSON):
{"areaName": "영역이름", "confidence": 0.0~1.0, "reason": "이유"}
```

**격려 메시지 프롬프트**
```
당신은 친절한 라이프 코치입니다.

[이번 주 현황]
{weeklyStats}

[목표 대비 달성률]
{goalComparison}

위 정보를 바탕으로 사용자에게 동기부여 메시지를 작성해주세요.

조건:
- 2-3문장으로 간결하게
- 잘하고 있는 점 언급
- 개선이 필요한 점은 부드럽게 제안
- 한국어로 작성
- 이모지 1-2개 사용 가능

응답 형식 (JSON):
{"message": "메시지 내용"}
```

### 7.3 클래스 구조

```
com.example.todomate.ai/
├── GeminiService.kt          // API 호출 담당
├── AiPromptBuilder.kt        // 프롬프트 생성
├── AiResponseParser.kt       // 응답 파싱
├── AiRepository.kt           // AI 관련 데이터 관리
└── model/
    ├── TagSuggestion.kt      // 태그 제안 결과
    ├── EncouragementMessage.kt
    └── TaskRecommendation.kt
```

---

## 8. 구현 우선순위

### Phase 1 (MVP)
1. Gemini API 연동 기본 설정
2. 격려 메시지 (대시보드 상단)
3. TodoEntity 확장 (aiSuggestedAreaId 추가)

### Phase 2
4. 자동 태깅 기능
5. 할 일 목록에 AI 제안 UI
6. 제안 적용/무시 기능

### Phase 3
7. 할 일 추천 기능
8. 패턴 분석 기능
9. 새로운 영역 제안

---

## 9. 보안 고려사항

### 9.1 API 키 관리
- API 키는 local.properties에 저장 (git 제외)
- BuildConfig를 통해 접근
- 절대 소스코드에 하드코딩 하지 않음

### 9.2 데이터 프라이버시
- 할 일 데이터는 분석 목적으로만 API에 전송
- 민감한 정보 필터링 고려
- 사용자에게 AI 분석 동의 받기 (선택적)

---

## 10. 테스트 계획

### 10.1 단위 테스트
- 프롬프트 생성 로직
- 응답 파싱 로직
- 충돌 방지 로직

### 10.2 통합 테스트
- API 호출 및 응답 처리
- 캐싱 동작
- 에러 처리

### 10.3 UI 테스트
- AI 제안 표시/숨김
- 적용/무시 버튼 동작
- 격려 메시지 표시

---

## 변경 이력

- 2024-02-07: 최초 작성
- 태그 방안: A (AI는 제안만, 사용자가 적용)
